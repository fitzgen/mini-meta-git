#!/usr/bin/env bash

cd ~/
git clone mini-meta-admin.git _temp

# Get rid of the old authorized keys and replace them with the new ones.

cd ~/.ssh
rm authorized_keys2

echo "### Autogenerated by mini-meta-git, DON'T EDIT BY HAND!" >> authorized_keys2
echo "### Instead, just add you public key to the mini-meta repository." >> authorized_keys2
for key in ~/_temp/*.pub; do
    cat $key >> authorized_keys2
done

# Go through the repositories file and make sure that all of the names in it are
# repositories. If one isn't yet, go ahead and `git --bare init` it.

cd ~/

if [ -f _temp/repositories ]; then
    for repo in $(cat _temp/repositories); do
        if [ ! -d "$repo.git" ]; then
            mkdir "$repo.git"
            cd "$repo.git"
            git --bare init
            cd -
        fi
    done
fi

rm -rf _temp